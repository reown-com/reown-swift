name: release

on:
  workflow_dispatch:
    inputs:
      app:
        type: choice
        description: Which sample app to release
        options:
        - DApp
        - WalletApp
        - Showcase

permissions:
  contents: read

jobs:
  build:
    runs-on: macos-latest-xlarge

    steps:
    - uses: actions/checkout@v3

    - name: Select Xcode 26 (iOS 26 SDK)
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26'

    - name: Setup SSH for Match
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.MATCH_SSH_KEY }}

    - uses: actions/cache@v3
      with:
        path: |
          .build
          SourcePackagesCache
          DerivedDataCache
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Release
      shell: bash
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        APPLE_ISSUER_ID: ${{ secrets.APPLE_ISSUER_ID }}
        APPLE_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
        APPLE_KEY_CONTENT: ${{ secrets.APPLE_KEY_CONTENT }}
        WALLETAPP_SENTRY_DSN: ${{ secrets.WALLETAPP_SENTRY_DSN }}
        MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
      run: |
        make release APPLE_ID=${{ secrets.APPLE_ID }} PROJECT_ID=${{ secrets.RELEASE_PROJECT_ID }} WALLETAPP_SENTRY_DSN=${{ secrets.WALLETAPP_SENTRY_DSN }} MIXPANEL_TOKEN=${{secrets.MIXPANEL_TOKEN}} APP=${{ github.event.inputs.app }}
